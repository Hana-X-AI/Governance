**Document Type**: Delivery - Infrastructure Procedure  
**Created**: 2025-11-05  
**Topic**: SSL/TLS Certificate Deployment  
**Purpose**: Secure services with HTTPS certificates from internal CA  
**Classification**: Internal

---

# SSL/TLS Certificate Deployment Procedures
**Purpose**: Secure services with HTTPS certificates  
**Applies To**: Web services (Nginx, Apache, application servers)  
**When**: DEPLOY-10 (Post-Deployment) or as needed

---

## Overview

This procedure covers generating SSL/TLS certificates from the internal Certificate Authority (CA) and deploying them to web services. This enables HTTPS with trusted certificates across the hx.dev.local infrastructure.

**What This Procedure Provides:**
- Certificate generation on CA server
- Certificate signing with internal CA
- Deployment package creation
- Web server configuration (Nginx/Apache)
- Testing and verification procedures

---

## Development Environment Notice

‚ö†Ô∏è **DEVELOPMENT ENVIRONMENT ONLY**

This procedure uses simplified security for hx.dev.local:
- CA Server SSH: agent0@192.168.10.201 / Major8859!
- CA Password: Longhorn88
- Service SSH: agent0@<SERVICE-IP> / Major8859!

**DO NOT** use these credentials in production environments.

**Credentials Reference**: `0.0.5.2-credentials/0.0.5.2.1-credentials.md`

---

## Prerequisites

**Required Access:**
- SSH to CA Server: `agent0@192.168.10.201` (Password: Major8859!)
- SSH to Service Server: `agent0@<SERVICE-IP>` (Password: Major8859!)

**Required Information:**
- Service hostname (e.g., hx-postgres.hx.dev.local)
- Service IP address (e.g., 192.168.10.209)
- Web server type (Nginx, Apache, etc.)

**Infrastructure:**
- CA Server: hx-ca-server (192.168.10.201)
- CA Password: Longhorn88
- Easy-RSA Directory: ~/easy-rsa-pki

---

## Step 1: Generate Certificate on CA Server

### SSH to CA Server

```bash
ssh agent0@192.168.10.201
# Password: Major8859!

cd ~/easy-rsa-pki
```

### Generate Certificate Request

```bash
# Generic template
./easyrsa gen-req <HOSTNAME>.hx.dev.local nopass

# When prompted for Common Name, press Enter to accept default

# Examples:
./easyrsa gen-req hx-postgres.hx.dev.local nopass
./easyrsa gen-req hx-redis.hx.dev.local nopass
./easyrsa gen-req hx-n8n.hx.dev.local nopass
./easyrsa gen-req hx-qdrant-ui.hx.dev.local nopass
```

**Expected Output:**
```
Common Name (eg: your user, host, or server name) [<HOSTNAME>.hx.dev.local]:
[Press Enter]

Keypair and certificate request completed. Your files are:
req: /home/agent0/easy-rsa-pki/pki/reqs/<HOSTNAME>.hx.dev.local.req
key: /home/agent0/easy-rsa-pki/pki/private/<HOSTNAME>.hx.dev.local.key
```

### Sign Certificate

```bash
./easyrsa sign-req server <HOSTNAME>.hx.dev.local

# Prompts:
# Confirm request details: yes
# Enter pass phrase for CA key: Longhorn88
```

**Expected Output:**
```
Certificate created at: /home/agent0/easy-rsa-pki/pki/issued/<HOSTNAME>.hx.dev.local.crt
```

---

## Step 2: Create Deployment Package

### Create Package Directory

```bash
# Generic template
mkdir -p ~/cert-deployment/<service-name>

# Examples:
mkdir -p ~/cert-deployment/postgres
mkdir -p ~/cert-deployment/redis
mkdir -p ~/cert-deployment/n8n
```

### Copy Certificates

```bash
# Copy CA root certificate
cp pki/ca.crt ~/cert-deployment/<service-name>/hx-ca.crt

# Copy server certificate
cp pki/issued/<HOSTNAME>.hx.dev.local.crt ~/cert-deployment/<service-name>/

# Copy private key
cp pki/private/<HOSTNAME>.hx.dev.local.key ~/cert-deployment/<service-name>/

# Set permissions
chmod 644 ~/cert-deployment/<service-name>/*.crt
chmod 600 ~/cert-deployment/<service-name>/*.key
```

### Verify Package

```bash
ls -lh ~/cert-deployment/<service-name>/

# Expected:
# -rw-r--r-- hx-ca.crt
# -rw-r--r-- <HOSTNAME>.hx.dev.local.crt
# -rw------- <HOSTNAME>.hx.dev.local.key
```

### Verify Certificate

```bash
openssl x509 -in ~/cert-deployment/<service-name>/<HOSTNAME>.hx.dev.local.crt -noout -subject -issuer -dates

# Expected:
# subject=CN = <HOSTNAME>.hx.dev.local
# issuer=CN = HX.DEV.LOCAL Internal CA
# notBefore=... 2025 GMT
# notAfter=... 2027 GMT  (2 years validity)
```

---

## Step 3: Deploy Certificates to Service Server

### Transfer Certificates

```bash
# From CA server
scp -r ~/cert-deployment/<service-name>/* agent0@<SERVICE-IP>:/tmp/
```

### SSH to Service Server

```bash
ssh agent0@<SERVICE-IP>
# Password: Major8859!
```

### Install CA Certificate to System

```bash
# Copy to system trust store
sudo cp /tmp/hx-ca.crt /usr/local/share/ca-certificates/

# Update certificates
sudo update-ca-certificates

# Verify
ls -la /etc/ssl/certs/ | grep hx-ca
```

### Create SSL Directory

```bash
# For Nginx
sudo mkdir -p /etc/nginx/ssl
sudo chmod 700 /etc/nginx/ssl

# For Apache
sudo mkdir -p /etc/apache2/ssl
sudo chmod 700 /etc/apache2/ssl

# For generic application
sudo mkdir -p /etc/<service>/ssl
sudo chmod 700 /etc/<service>/ssl
```

### Deploy Server Certificates

```bash
# Generic (adjust path for web server)
SSL_DIR="/etc/nginx/ssl"  # or /etc/apache2/ssl or /etc/<service>/ssl

sudo cp /tmp/<HOSTNAME>.hx.dev.local.crt $SSL_DIR/
sudo cp /tmp/<HOSTNAME>.hx.dev.local.key $SSL_DIR/
sudo cp /tmp/hx-ca.crt $SSL_DIR/

# Set permissions
sudo chmod 644 $SSL_DIR/*.crt
sudo chmod 600 $SSL_DIR/*.key
sudo chown root:root $SSL_DIR/*

# Clean up
rm /tmp/*.crt /tmp/*.key
```

---

## Step 4: Configure Web Server for HTTPS

### Nginx Configuration

```nginx
# HTTP server - Redirect to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name <HOSTNAME>.hx.dev.local <HOSTNAME>-server.hx.dev.local <IP-ADDRESS>;

    return 301 https://$host$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name <HOSTNAME>.hx.dev.local <HOSTNAME>-server.hx.dev.local <IP-ADDRESS>;

    # Document root
    root /var/www/html;  # Adjust as needed
    index index.html index.htm;

    # SSL Certificates
    ssl_certificate /etc/nginx/ssl/<HOSTNAME>.hx.dev.local.crt;
    ssl_certificate_key /etc/nginx/ssl/<HOSTNAME>.hx.dev.local.key;
    ssl_trusted_certificate /etc/nginx/ssl/hx-ca.crt;

    # SSL Protocols and Ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL Session
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # OCSP Stapling (gracefully fails for internal CA)
    ssl_stapling on;
    ssl_stapling_verify on;

    # Security Headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Hide version
    server_tokens off;

    # Application-specific location blocks
    location / {
        try_files $uri $uri/ =404;
        # Or proxy_pass, fastcgi_pass, etc.
    }

    # Logging
    access_log /var/log/nginx/<service>-access.log;
    error_log /var/log/nginx/<service>-error.log;
}
```

### Apache Configuration

```apache
# File: /etc/apache2/sites-available/<service>-ssl.conf

<VirtualHost *:80>
    ServerName <HOSTNAME>.hx.dev.local
    ServerAlias <HOSTNAME>-server.hx.dev.local <IP-ADDRESS>

    # Redirect to HTTPS
    Redirect permanent / https://<HOSTNAME>.hx.dev.local/
</VirtualHost>

<VirtualHost *:443>
    ServerName <HOSTNAME>.hx.dev.local
    ServerAlias <HOSTNAME>-server.hx.dev.local <IP-ADDRESS>

    DocumentRoot /var/www/html

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/<HOSTNAME>.hx.dev.local.crt
    SSLCertificateKeyFile /etc/apache2/ssl/<HOSTNAME>.hx.dev.local.key
    SSLCertificateChainFile /etc/apache2/ssl/hx-ca.crt

    # SSL Protocols
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/<service>-error.log
    CustomLog ${APACHE_LOG_DIR}/<service>-access.log combined
</VirtualHost>
```

---

## Step 5: Apply Configuration

### Nginx

```bash
# Test configuration
sudo nginx -t

# Expected: syntax is ok, test is successful

# Reload Nginx
sudo systemctl reload nginx

# Verify status
sudo systemctl status nginx

# Check ports
sudo ss -tuln | grep -E ':80|:443'
# Expected: Listening on 0.0.0.0:80 and 0.0.0.0:443
```

### Apache

```bash
# Enable SSL module
sudo a2enmod ssl
sudo a2enmod headers

# Enable site
sudo a2ensite <service>-ssl

# Test configuration
sudo apache2ctl configtest

# Reload Apache
sudo systemctl reload apache2

# Verify status
sudo systemctl status apache2
```

---

## Step 6: Testing and Verification

### Test HTTP Redirect

```bash
curl -I http://<HOSTNAME>.hx.dev.local/

# Expected:
# HTTP/1.1 301 Moved Permanently
# Location: https://<HOSTNAME>.hx.dev.local/
```

### Test HTTPS Access (Local)

```bash
curl -I https://localhost/

# Expected:
# HTTP/2 200
# strict-transport-security: max-age=63072000
```

### Test HTTPS Access (Remote)

```bash
ssh agent0@<ANY-SERVER-IP>
curl -I https://<HOSTNAME>.hx.dev.local/

# Expected: HTTP/2 200
```

### Verify SSL Certificate

```bash
echo | openssl s_client -connect <HOSTNAME>.hx.dev.local:443 -servername <HOSTNAME>.hx.dev.local 2>/dev/null | openssl x509 -noout -subject -issuer -dates

# Expected:
# subject=CN = <HOSTNAME>.hx.dev.local
# issuer=CN = HX.DEV.LOCAL Internal CA
# notBefore=... 2025 GMT
# notAfter=... 2027 GMT
```

### Test TLS Versions

```bash
# TLS 1.2
openssl s_client -connect <HOSTNAME>.hx.dev.local:443 -tls1_2 < /dev/null 2>&1 | grep "Protocol"

# TLS 1.3
openssl s_client -connect <HOSTNAME>.hx.dev.local:443 -tls1_3 < /dev/null 2>&1 | grep "Protocol"
```

### Browser Testing

1. Open: `http://<HOSTNAME>.hx.dev.local/` ‚Üí Should redirect to HTTPS
2. Open: `https://<HOSTNAME>.hx.dev.local/` ‚Üí Should show üîí Secure
3. Click padlock ‚Üí View certificate ‚Üí Verify issuer and expiration

---

## Troubleshooting SSL

### Issue: "Certificate Not Trusted" in Browser

```bash
# Cause: CA root cert not installed on workstation

# Linux workstation
scp agent0@192.168.10.201:~/easy-rsa-pki/pki/ca.crt /tmp/hx-ca.crt
sudo cp /tmp/hx-ca.crt /usr/local/share/ca-certificates/
sudo update-ca-certificates

# Windows: Import ca.crt to Trusted Root Certification Authorities
# macOS:
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain /tmp/hx-ca.crt
```

### Issue: HTTP Still Works, No Redirect

```bash
# Check configuration
sudo nginx -t

# Test redirect
curl -I http://<HOSTNAME>.hx.dev.local/
# Should show: 301 Moved Permanently

# Reload web server
sudo systemctl reload nginx  # or apache2
```

### Issue: Certificate Expired

```bash
# Check expiration
openssl x509 -in /etc/nginx/ssl/<HOSTNAME>.hx.dev.local.crt -noout -dates

# Renew: Generate new certificate (repeat Steps 1-5)
```

### Issue: OCSP Stapling Warnings

```bash
# This is NORMAL for internal CA (no OCSP responder)
# OCSP stapling gracefully disabled

# Optional: Disable in config to suppress warnings
# Comment out in Nginx:
# ssl_stapling on;
# ssl_stapling_verify on;
```

---

## SSL Best Practices

### Certificate Management

- Store certificates: 644 permissions
- Store private keys: 600 permissions
- SSL directories: 700 permissions
- Set calendar reminder for certificate expiration (2 years)

### Security Headers (Already in Config)

- HSTS: Enforces HTTPS
- X-Frame-Options: Prevents clickjacking
- X-Content-Type-Options: Prevents MIME sniffing
- X-XSS-Protection: XSS filtering

### Regular Maintenance

```bash
# Weekly: Check certificate validity (30-day warning)
echo | openssl s_client -connect <HOSTNAME>.hx.dev.local:443 2>/dev/null | openssl x509 -noout -checkend 2592000
# Exit 0: Valid for 30+ days
# Exit 1: Expires in <30 days

# Monthly: Review logs
sudo tail -100 /var/log/nginx/<service>-error.log

# Quarterly: Test SSL config
curl -I https://<HOSTNAME>.hx.dev.local/
```

---

## Quick Reference Commands

### Generate Certificate
```bash
ssh agent0@192.168.10.201
cd ~/easy-rsa-pki
./easyrsa gen-req <HOSTNAME>.hx.dev.local nopass
./easyrsa sign-req server <HOSTNAME>.hx.dev.local
# CA password: Longhorn88
```

### Deploy Certificate
```bash
# Create package
mkdir -p ~/cert-deployment/<service>
cp pki/ca.crt ~/cert-deployment/<service>/hx-ca.crt
cp pki/issued/<HOSTNAME>.hx.dev.local.crt ~/cert-deployment/<service>/
cp pki/private/<HOSTNAME>.hx.dev.local.key ~/cert-deployment/<service>/

# Transfer
scp -r ~/cert-deployment/<service>/* agent0@<SERVICE-IP>:/tmp/

# Install on service server
ssh agent0@<SERVICE-IP>
sudo mkdir -p /etc/nginx/ssl
sudo cp /tmp/<HOSTNAME>.hx.dev.local.crt /etc/nginx/ssl/
sudo cp /tmp/<HOSTNAME>.hx.dev.local.key /etc/nginx/ssl/
sudo cp /tmp/hx-ca.crt /etc/nginx/ssl/
sudo chmod 644 /etc/nginx/ssl/*.crt
sudo chmod 600 /etc/nginx/ssl/*.key
```

### Test HTTPS
```bash
curl -I https://<HOSTNAME>.hx.dev.local/
```

---

## Certificate Standards

**Certificate Details:**
- CN: `<hostname>.hx.dev.local`
- Validity: 730 days (2 years)
- Issuer: HX.DEV.LOCAL Internal CA
- Location: `/etc/nginx/ssl/` or `/etc/apache2/ssl/`

**File Permissions:**
- Certificates (.crt): 644
- Private Keys (.key): 600
- SSL Directory: 700

---

## Related Procedures

- **LDAP Integration**: `0.0.5.3.2-ldap-domain-integration.md`
- **DNS Management**: `0.0.5.3.1-dns-management.md`
- **Credentials Reference**: `0.0.5.2-credentials/0.0.5.2.1-credentials.md`

---

**Version**: 1.0  
**Maintained By**: Infrastructure Team / Agent Frank  
**Related Documents**:
- `0.0.5.3.1-dns-management.md` - DNS Management
- `0.0.5.3.2-ldap-domain-integration.md` - LDAP Integration  
**Classification**: Internal  
**Status**: Active - Production Ready  
**Last Review**: 2025-11-06
