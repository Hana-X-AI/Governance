# URL-Safe Password Pattern for Database Service Accounts

**Document Type**: Best Practice / Lessons Learned
**Created**: 2025-11-08
**Topic**: Database Service Account Password Standards
**Purpose**: Document the URL-safe password pattern for TypeORM/Prisma applications
**Classification**: Internal

---

## Problem Statement

**Issue**: Applications using TypeORM, Prisma, or other ORMs that use connection URL format fail when PostgreSQL passwords contain special characters (e.g., `!`, `@`, `#`, `%`).

**Symptoms**:
- Database connection failures with URL encoding errors
- Systemd service startup failures
- Connection strings not parsing correctly
- Environment variables not loading properly

**Root Cause**: URL encoding of special characters in connection strings:
- `!` becomes `%21`
- `@` becomes `%40` (also delimiter conflict)
- `#` becomes `%23` (also fragment identifier)
- Other special characters cause similar issues

---

## Solution: URL-Safe Service Account Pattern

### Established Pattern

**For applications requiring database connection URLs**, create dedicated PostgreSQL service accounts with URL-safe passwords (alphanumeric only, no special characters).

**Pattern Name**: `svc-{application}` with password `Major8859`

### Applications Using This Pattern

| Application | Service Account | Password | Database | Date Created | Reference |
|-------------|-----------------|----------|----------|--------------|-----------|
| **LiteLLM** | `svc-litellm` | `Major8859` | `litellm` | 2025-10-31 | credentials.md:610-699 |
| **N8N** | `svc-n8n` | `Major8859` | `n8n_poc3` | 2025-11-08 | credentials.md:703-785 |

### Standard Password

**Development Environment**: `Major8859`
- **No special characters** (exclamation mark removed)
- **URL-safe**: Works in connection strings without encoding
- **Consistent**: Same password across all URL-safe service accounts
- **Acceptable**: For hx.dev.local development environment

**Production Environment**: Generate unique 16+ character passwords per service (still URL-safe: alphanumeric + `-_` only)

---

## Implementation Checklist

When deploying a new application requiring PostgreSQL database access:

### 1. Determine if URL-Safe Account Needed

**Create `svc-{app}` account if**:
- ✅ Application uses connection URL format (e.g., `postgresql://user:pass@host/db`)
- ✅ Application uses TypeORM (N8N, NestJS apps)
- ✅ Application uses Prisma (LiteLLM, many Next.js apps)
- ✅ Application uses Sequelize or other URL-based ORMs
- ✅ Systemd EnvironmentFile has issues with special characters

**Use standard credentials if**:
- ❌ Application uses separate environment variables (host, port, user, password)
- ❌ Application uses native PostgreSQL connection libraries (psycopg2, pg, etc.)
- ❌ Application is administrative/CLI tool (psql, pg_dump, etc.)

### 2. Create PostgreSQL Service Account

```bash
# On hx-postgres-server (192.168.10.209)
sudo -u postgres psql

# Create role with URL-safe password
CREATE ROLE "svc-{application}" WITH LOGIN PASSWORD 'Major8859';

# Grant database access
GRANT CONNECT ON DATABASE {database_name} TO "svc-{application}";
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "svc-{application}";
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "svc-{application}";
GRANT CREATE ON SCHEMA public TO "svc-{application}";

# Set default privileges for future objects
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "svc-{application}";
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "svc-{application}";
```

### 3. Test Connection

```bash
# From application server
PGPASSWORD='Major8859' psql -h hx-postgres-server.hx.dev.local -U svc-{application} -d {database_name}

# Verify access
\dt  # List tables
SELECT current_user;  # Verify role
```

### 4. Configure Application

**Preferred Method (Separate Variables)**:
```bash
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=hx-postgres-server.hx.dev.local
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE={database_name}
DB_POSTGRESDB_USER=svc-{application}
DB_POSTGRESDB_PASSWORD=Major8859
```

**Alternative Method (Connection URL)**:
```bash
DATABASE_URL=postgresql://svc-{application}:Major8859@hx-postgres-server.hx.dev.local:5432/{database_name}
```

### 5. Document in Credentials File

Add entry to `0.0.5.2.1-credentials.md` following the template in sections 10 (svc-litellm) and 11 (svc-n8n).

---

## Decision Matrix: Which Account Type to Use

```
┌─────────────────────────────────────────────────────────────────┐
│ Application Uses Connection URL Format?                        │
│ (e.g., postgresql://user:pass@host/db)                        │
└───────────────────┬─────────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
       YES                     NO
        │                       │
        ▼                       ▼
┌───────────────────┐   ┌───────────────────┐
│ Use svc-{app}     │   │ Use standard      │
│ Password:         │   │ credentials       │
│ Major8859         │   │ Password:         │
│                   │   │ Major8859!        │
│ Examples:         │   │                   │
│ - N8N             │   │ Examples:         │
│ - LiteLLM         │   │ - psql            │
│ - Prisma apps     │   │ - pg_dump         │
│ - TypeORM apps    │   │ - Admin tools     │
└───────────────────┘   └───────────────────┘
```

---

## Historical Context

### Deployments Where This Issue Occurred

1. **LiteLLM (2025-10-31)**:
   - Initial password: `Major8859!`
   - Issue: Prisma connection URL parsing failed
   - Solution: Created `svc-litellm` with `Major8859`
   - Status: ✅ Resolved

2. **N8N (2025-11-08)**:
   - Initial password: `Major8859!` (user `n8n_user`)
   - Issue: TypeORM connection URL encoding failed, systemd startup issues
   - Solution: Created `svc-n8n` with `Major8859`
   - Status: ✅ Resolved

### Why This Keeps Happening

**Root Cause**: Standard Hana-X credential policy uses `Major8859!` for consistency, but this conflicts with URL-based database clients.

**Pattern Recognition**: When deploying TypeORM/Prisma applications, proactively create URL-safe accounts instead of discovering the issue during deployment.

---

## Best Practices

### DO ✅

1. **Proactively identify** if application uses connection URL format
2. **Create dedicated service accounts** for each application (isolation)
3. **Use URL-safe passwords** (`Major8859` in dev, alphanumeric in prod)
4. **Document immediately** in credentials.md when creating new accounts
5. **Test connection** from application server before configuring service
6. **Reference existing patterns** (svc-litellm, svc-n8n) when creating new accounts

### DON'T ❌

1. **Don't assume** all applications work with special character passwords
2. **Don't reuse** standard credentials when URL format is required
3. **Don't skip** connection testing before deployment
4. **Don't create** service accounts without documenting them
5. **Don't use** special characters in URLs without proper escaping (unreliable)

---

## Security Considerations

### Development Environment (hx.dev.local)

**Acceptable Tradeoffs**:
- ✅ Simplified password (`Major8859`) for URL compatibility
- ✅ Password reuse across URL-safe service accounts
- ✅ Internal network only (192.168.10.0/24)
- ✅ Development/testing environment

**Mitigations**:
- ✅ Dedicated service account per application (isolation)
- ✅ Database-level access control (per-database privileges)
- ✅ Network segmentation (PostgreSQL not exposed externally)
- ✅ Regular credential rotation schedule (quarterly)

### Production Environment

**Requirements**:
- ✅ Unique 16+ character passwords per service account
- ✅ Password complexity: Alphanumeric + `-_` (URL-safe only)
- ✅ Secrets management (HashiCorp Vault, AWS Secrets Manager)
- ✅ Password rotation (90 days)
- ✅ MFA for administrative access
- ✅ Audit logging of credential usage

---

## Future Applications

### Known Upcoming Applications

| Application | ORM/Client | URL Format? | Account Needed | Priority |
|-------------|------------|-------------|----------------|----------|
| Supabase | PostgreSQL native | TBD | TBD | Medium |
| Strapi | Knex.js | Yes (likely) | `svc-strapi` | Low |
| Hasura | PostgreSQL native | No | Standard | Low |

### Proactive Planning

When planning new application deployments:

1. **Research database client**: Check if connection URL format is used
2. **Review documentation**: Look for examples like `DATABASE_URL=postgresql://...`
3. **Create account early**: Set up `svc-{app}` account during planning phase
4. **Test before deployment**: Verify connection from target server
5. **Document upfront**: Add to credentials.md before deployment begins

---

## Related Documents

- **Primary Reference**: `0.0.5.2.1-credentials.md` (sections 10 & 11)
- **LiteLLM Deployment**: `/srv/cc/Governance/{litellm-project-docs}`
- **N8N Deployment**: `/srv/cc/Governance/x-poc3-n8n-deployment/p3-execution/PHASE3-COMPLETION-SUMMARY.md`
- **PostgreSQL Server**: hx-postgres-server.hx.dev.local (192.168.10.209)

---

## Maintenance

**Review Schedule**: Quarterly (every 3 months)
**Owner**: Security Team / Database Administrator
**Last Review**: 2025-11-08
**Next Review**: 2026-02-08

**Update Triggers**:
- New application deployment with database requirement
- Discovery of new URL encoding issues
- Production migration planning
- Password policy changes

---

**Document Version**: 1.0
**Created By**: Claude (AI Assistant) + Omar Rodriguez (Build Specialist) + Quinn Davis (Database Specialist)
**Approved By**: User (CAIO - Chief AI Officer)
**Status**: ✅ ACTIVE BEST PRACTICE
**Classification**: Internal
