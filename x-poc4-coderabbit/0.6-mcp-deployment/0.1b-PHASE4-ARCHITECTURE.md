# Roger MCP Server - Phase 4.0 Architecture

**Document Type**: Technical Architecture  
**Created**: November 11, 2025  
**Project**: Roger MCP Server Phase 4.0 - Network-Accessible Code Review Service  
**Server**: hx-coderabbit-server.hx.dev.local (192.168.10.228:8005)  
**Status**: Architecture Design Document  
**Classification**: Internal - Technical Architecture

---

## Document Purpose

This document defines the complete technical architecture for Roger MCP Server Phase 4.0, including HTTP/SSE transport layer design, MCP protocol integration, component interactions, data flows, security architecture, and deployment topology. It serves as the authoritative reference for all architectural decisions and provides the foundation for implementation.

---

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [System Context](#2-system-context)
3. [Component Architecture](#3-component-architecture)
4. [Transport Layer Design](#4-transport-layer-design)
5. [MCP Protocol Integration](#5-mcp-protocol-integration)
6. [Data Architecture](#6-data-architecture)
7. [Security Architecture](#7-security-architecture)
8. [Deployment Architecture](#8-deployment-architecture)
9. [Performance Architecture](#9-performance-architecture)
10. [Integration Architecture](#10-integration-architecture)
11. [Operational Architecture](#11-operational-architecture)
12. [Architecture Decision Records](#12-architecture-decision-records)

---

## 1. Architecture Overview

### 1.1 Executive Summary

Roger MCP Server Phase 4.0 transforms Roger from a local CLI tool into a network-accessible service that exposes code review capabilities via the Model Context Protocol (MCP). The architecture follows a layered approach with clear separation of concerns:

- **Layer 1 (Core)**: Existing Roger Phase 3 implementation (unchanged)
- **Layer 2 (Transport)**: New HTTP/SSE transport layer
- **Layer 3 (Protocol)**: MCP protocol handler
- **Layer 4 (Network)**: HTTP server infrastructure

**Key Architectural Principles**:
1. **Separation of Concerns**: Transport logic separate from business logic
2. **Backward Compatibility**: Zero changes to Roger Phase 3 core
3. **Standards-Based**: MCP protocol compliance, HTTP/SSE standards
4. **Security-First**: Defense in depth, least privilege
5. **Operational Excellence**: Observability, maintainability, reliability

### 1.2 Architecture Stakeholders

| Stakeholder | Interest | Concerns |
|-------------|----------|----------|
| **Agent Zero** | Overall system success | Quality, timeline, integration |
| **Alex Rivera** | Architecture governance | Standards compliance, scalability |
| **Developers** | Using Roger via Claude Code | Ease of use, reliability, performance |
| **Operations** | Running and maintaining service | Stability, observability, troubleshooting |
| **Security** | System security posture | Authentication, encryption, audit |

### 1.3 Architecture Goals

**Functional Goals**:
- ✅ Expose Roger functionality via MCP protocol
- ✅ Support multiple concurrent clients
- ✅ Maintain all Phase 3 capabilities
- ✅ Enable network access across Hana-X infrastructure

**Non-Functional Goals**:
- ✅ Performance: < 5 minute response time for typical reviews
- ✅ Availability: 99.5% uptime SLA
- ✅ Scalability: Support 10+ concurrent clients
- ✅ Maintainability: Clear component boundaries, documented interfaces
- ✅ Security: Defense in depth, audit logging

### 1.4 Architecture Constraints

**Technical Constraints**:
- Must use Python 3.10+ (Hana-X standard)
- Must integrate with existing Redis (Layer 3 cache)
- Must not modify Roger Phase 3 core
- Must support MCP protocol version 2024-11-05
- Must deploy on Ubuntu 24.04

**Business Constraints**:
- Internal network only (192.168.10.0/24)
- No external dependencies beyond Hana-X infrastructure
- Must leverage existing Samba DC for future authentication

**Operational Constraints**:
- Single server deployment (Phase 4.0)
- Must use systemd for service management
- Must integrate with existing monitoring (Nathan Lewis)

---

## 2. System Context

### 2.1 System Context Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│  External Context: Hana-X Infrastructure (192.168.10.0/24)          │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  Client Layer                                                 │ │
│  │                                                               │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │ │
│  │  │ hx-cc-     │  │ hx-dev-    │  │ hx-demo-   │             │ │
│  │  │ server     │  │ server     │  │ server     │             │ │
│  │  │            │  │            │  │            │             │ │
│  │  │ Claude     │  │ Claude     │  │ Claude     │             │ │
│  │  │ Code       │  │ Code       │  │ Code       │             │ │
│  │  │ + MCP      │  │ + MCP      │  │ + MCP      │             │ │
│  │  │ Client     │  │ Client     │  │ Client     │   [+ More]  │ │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘             │ │
│  └────────┼───────────────┼───────────────┼────────────────────┘ │
│           │               │               │                       │
│           │ MCP over      │ MCP over      │ MCP over              │
│           │ HTTP/SSE      │ HTTP/SSE      │ HTTP/SSE              │
│           │               │               │                       │
│           └───────────────┴───────────────┘                       │
│                           │                                       │
│                           ↓                                       │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Roger MCP Server                                          │  │
│  │  hx-coderabbit-server.hx.dev.local (192.168.10.228:8005)  │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │  HTTP/SSE Transport Layer (NEW - Phase 4)           │ │  │
│  │  │  - Port 8005 listener                               │ │  │
│  │  │  - SSE connection management                        │ │  │
│  │  │  - MCP protocol handler                             │ │  │
│  │  └──────────────────┬───────────────────────────────────┘ │  │
│  │                     │                                     │  │
│  │  ┌──────────────────▼───────────────────────────────────┐ │  │
│  │  │  Roger Core (EXISTING - Phase 3)                     │ │  │
│  │  │                                                       │ │  │
│  │  │  ┌───────────────┐       ┌───────────────────────┐  │ │  │
│  │  │  │  Layer 1      │       │  Layer 3              │  │ │  │
│  │  │  │  Linters      │       │  CodeRabbit API       │  │ │  │
│  │  │  │               │       │                       │  │ │  │
│  │  │  │  • bandit     │       │  • API wrapper        │  │ │  │
│  │  │  │  • pylint     │       │  • Cache (Redis)      │  │ │  │
│  │  │  │  • mypy       │       │  • Rate limiting      │  │ │  │
│  │  │  │  • radon      │       │  • Finding parser     │  │ │  │
│  │  │  │  • flake8     │       │                       │  │ │  │
│  │  │  │  • vulture    │       │                       │  │ │  │
│  │  │  └───────────────┘       └───────────────────────┘  │ │  │
│  │  └───────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────┘  │
│                           │                                       │
│                           │ Dependencies                          │
│                           ↓                                       │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Supporting Services                                       │  │
│  │                                                            │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │  │
│  │  │ Redis        │  │ Samba DC     │  │ DNS          │    │  │
│  │  │ (Cache)      │  │ (Auth)       │  │ (Resolution) │    │  │
│  │  │ 127.0.0.1    │  │ .200         │  │ .200         │    │  │
│  │  │ :6379        │  │ (Phase 4.1)  │  │              │    │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

### 2.2 System Boundaries

**In Scope (Phase 4.0)**:
- HTTP/SSE transport layer implementation
- MCP protocol handler
- Network accessibility (port 8005)
- Integration with Roger Phase 3 core
- Redis cache integration
- Health check endpoints
- Basic operational monitoring

**Out of Scope (Phase 4.0)**:
- Authentication/authorization (Phase 4.1)
- TLS/HTTPS encryption (Phase 4.1)
- Load balancing (Phase 4.2)
- High availability (Phase 4.2)
- CodeRabbit CLI changes
- Roger Phase 3 core modifications

**Deferred to Future Phases**:
- Kerberos integration (Phase 4.1)
- API key authentication (Phase 4.1)
- Rate limiting per client (Phase 4.1)
- Horizontal scaling (Phase 4.2)
- Disaster recovery (Phase 4.2)

### 2.3 External Interfaces

**Client Interface**:
- **Protocol**: MCP over HTTP/SSE
- **Transport**: HTTP 1.1 with Server-Sent Events
- **Endpoint**: `http://192.168.10.228:8005/sse`
- **Format**: JSON-RPC 2.0
- **Authentication**: None (Phase 4.0), Kerberos (Phase 4.1)

**Cache Interface**:
- **Service**: Redis (Samuel Wilson)
- **Connection**: `127.0.0.1:6379`
- **Protocol**: Redis protocol
- **Purpose**: Layer 3 CodeRabbit cache, rate limiting

**DNS Interface**:
- **Service**: Samba DC DNS (Frank Lucas)
- **Server**: `192.168.10.200`
- **Record**: `hx-coderabbit-server.hx.dev.local → 192.168.10.228`

**Monitoring Interface**:
- **Service**: Metrics Server (Nathan Lewis)
- **Protocol**: Prometheus (future)
- **Logs**: Systemd journal + file logs

---

## 3. Component Architecture

### 3.1 Layered Architecture

Roger MCP Server follows a strict layered architecture with unidirectional dependencies:

```
┌───────────────────────────────────────────────────────────┐
│  Layer 4: HTTP Server Infrastructure                      │
│  - Uvicorn ASGI server                                    │
│  - Port binding and network I/O                           │
│  - Connection management                                  │
└─────────────────────┬─────────────────────────────────────┘
                      │ depends on
                      ↓
┌───────────────────────────────────────────────────────────┐
│  Layer 3: MCP Protocol Layer                              │
│  - JSON-RPC 2.0 message parsing                           │
│  - MCP method routing (initialize, tools/call, etc.)      │
│  - Request/response correlation                           │
│  - Error handling and formatting                          │
└─────────────────────┬─────────────────────────────────────┘
                      │ depends on
                      ↓
┌───────────────────────────────────────────────────────────┐
│  Layer 2: Transport Adapter                               │
│  - Roger core invocation                                  │
│  - Parameter translation (MCP ↔ Roger)                    │
│  - Result formatting                                      │
│  - Async/sync bridging                                    │
└─────────────────────┬─────────────────────────────────────┘
                      │ depends on
                      ↓
┌───────────────────────────────────────────────────────────┐
│  Layer 1: Roger Core (Phase 3 - UNCHANGED)                │
│  - Layer 1 linters (bandit, pylint, mypy, etc.)          │
│  - Layer 3 CodeRabbit integration                         │
│  - Finding aggregation and parsing                        │
│  - Defect logging                                         │
└───────────────────────────────────────────────────────────┘
```

**Key Architectural Principle**: Each layer only depends on the layer directly below it. No layer skipping.

### 3.2 Component Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│  roger_http_server.py (NEW)                                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Main Application                                       │   │
│  │  - Configuration loading                                │   │
│  │  - Server initialization                                │   │
│  │  - Lifecycle management                                 │   │
│  └───────────────────┬─────────────────────────────────────┘   │
│                      │                                          │
│  ┌───────────────────▼─────────────────────────────────────┐   │
│  │  HTTP Server (Uvicorn/Starlette)                        │   │
│  │                                                          │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │   │
│  │  │ /sse       │  │ /health    │  │ /metrics   │        │   │
│  │  │ endpoint   │  │ endpoint   │  │ (future)   │        │   │
│  │  └──────┬─────┘  └──────┬─────┘  └────────────┘        │   │
│  └─────────┼────────────────┼──────────────────────────────┘   │
│            │                │                                   │
│  ┌─────────▼────────────────▼──────────────────────────────┐   │
│  │  SSE Connection Manager                                 │   │
│  │  - Connection tracking                                  │   │
│  │  - Keep-alive management                                │   │
│  │  - Client registration                                  │   │
│  └───────────────────┬─────────────────────────────────────┘   │
│                      │                                          │
│  ┌───────────────────▼─────────────────────────────────────┐   │
│  │  MCP Protocol Handler                                   │   │
│  │                                                          │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │   │
│  │  │ initialize │  │ tools/list │  │ tools/call │        │   │
│  │  │ handler    │  │ handler    │  │ handler    │        │   │
│  │  └──────┬─────┘  └──────┬─────┘  └──────┬─────┘        │   │
│  └─────────┼────────────────┼───────────────┼──────────────┘   │
│            │                │               │                   │
│  ┌─────────▼────────────────▼───────────────▼──────────────┐   │
│  │  Roger Adapter                                          │   │
│  │  - Parameter validation                                 │   │
│  │  - Roger orchestrator invocation                        │   │
│  │  - Result formatting                                    │   │
│  └───────────────────┬─────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────┘
                       │
                       │ Python import
                       ↓
┌─────────────────────────────────────────────────────────────────┐
│  roger_core/ (Phase 3 - EXISTING)                              │
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │  roger_orchestrator.py                                │     │
│  │  - Main entry point                                   │     │
│  │  - Layer 1 + Layer 3 coordination                     │     │
│  └───────────────────┬───────────────────────────────────┘     │
│                      │                                          │
│  ┌───────────────────▼───────────────────────────────────┐     │
│  │  linter_aggregator.py (Layer 1)                       │     │
│  │  - 6 linter execution                                 │     │
│  │  - Finding aggregation                                │     │
│  └─────────────────────────────────────────────────────────    │
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │  coderabbit_api.py (Layer 3)                          │     │
│  │  - CodeRabbit CLI invocation                          │     │
│  │  - API response parsing                               │     │
│  └───────────────────┬───────────────────────────────────┘     │
│                      │                                          │
│  ┌───────────────────▼───────────────────────────────────┐     │
│  │  layer3_cache.py                                      │     │
│  │  - Redis integration                                  │     │
│  │  - Cache operations                                   │     │
│  └───────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 Component Responsibilities

#### Main Application Component
**File**: `roger_http_server.py`  
**Responsibilities**:
- Load configuration from `server.yaml`
- Initialize HTTP server (Uvicorn)
- Register endpoints and handlers
- Graceful shutdown management
- Signal handling (SIGTERM, SIGINT)

**Dependencies**:
- Uvicorn (ASGI server)
- Starlette (web framework)
- YAML configuration library
- Logging infrastructure

#### HTTP Server Component
**Framework**: Uvicorn + Starlette  
**Responsibilities**:
- Listen on 0.0.0.0:8005
- Handle HTTP requests
- Manage SSE connections
- Serve health check endpoint
- Request routing

**Endpoints**:
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/sse` | GET | MCP SSE endpoint (primary) |
| `/health` | GET | Health check endpoint |
| `/metrics` | GET | Prometheus metrics (future) |

#### SSE Connection Manager Component
**Responsibilities**:
- Track active SSE connections
- Manage connection lifecycle (open, close, timeout)
- Send keep-alive pings
- Handle client disconnections
- Connection pool management

**Data Structures**:
```python
class Connection:
    id: str
    client_ip: str
    connected_at: datetime
    last_activity: datetime
    queue: asyncio.Queue  # For sending messages
```

#### MCP Protocol Handler Component
**Responsibilities**:
- Parse JSON-RPC 2.0 messages
- Route to appropriate handlers
- Validate MCP protocol compliance
- Generate responses
- Error handling and formatting

**Supported Methods**:
| Method | Purpose | Handler |
|--------|---------|---------|
| `initialize` | MCP handshake | `handle_initialize()` |
| `tools/list` | List available tools | `handle_tools_list()` |
| `tools/call` | Execute a tool | `handle_tools_call()` |
| `ping` | Keep-alive | `handle_ping()` |

#### Roger Adapter Component
**Responsibilities**:
- Translate MCP parameters to Roger orchestrator format
- Invoke Roger synchronously (in thread pool)
- Format Roger results as MCP responses
- Handle Roger exceptions
- Timeout management

**Interface**:
```python
async def roger_review(
    path: str,
    enable_layer3: bool = True,
    layer3_timeout: int = 120,
    layer3_cache_enabled: bool = True
) -> Dict[str, Any]
```

---

## 4. Transport Layer Design

### 4.1 HTTP/SSE Architecture

**Why Server-Sent Events?**
1. **MCP Standard**: MCP protocol specifies SSE as transport
2. **Unidirectional**: Server → Client (fits MCP model)
3. **HTTP-Based**: Works with existing infrastructure
4. **Simple**: Easier than WebSockets, no handshake complexity
5. **Firewall-Friendly**: Standard HTTP/HTTPS ports

**SSE Connection Flow**:
```
Client                                   Server
  │                                        │
  │ 1. HTTP GET /sse                       │
  │───────────────────────────────────────>│
  │                                        │
  │ 2. HTTP 200 OK                         │
  │    Content-Type: text/event-stream    │
  │<───────────────────────────────────────│
  │                                        │
  │ 3. Connection established              │
  │    (keep-alive, no close)             │
  │                                        │
  │ 4. Client sends JSON-RPC via POST     │
  │    (piggybacks on SSE connection)     │
  │───────────────────────────────────────>│
  │                                        │
  │ 5. Server processes request           │
  │    (Roger invocation)                 │
  │                                        │
  │ 6. Server sends response via SSE      │
  │    data: {"jsonrpc":"2.0",...}        │
  │<───────────────────────────────────────│
  │                                        │
  │ 7. Keep-alive pings (every 30s)       │
  │<───────────────────────────────────────│
  │                                        │
  │ ... more requests/responses ...        │
  │                                        │
  │ 8. Client closes connection           │
  │    (or timeout after inactivity)      │
  │                                        │
```

### 4.2 Request/Response Protocol

**Request Format (JSON-RPC 2.0)**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "roger_review",
    "arguments": {
      "path": "/path/to/code",
      "enable_layer3": true,
      "layer3_timeout": 120
    }
  }
}
```

**Response Format (JSON-RPC 2.0)**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "Code review results:\n- Layer 1: 5 issues\n- Layer 3: 2 suggestions"
      }
    ]
  }
}
```

**Error Format**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32603,
    "message": "Internal error",
    "data": {
      "details": "Roger orchestrator failed: timeout"
    }
  }
}
```

### 4.3 Connection Management

**Connection Lifecycle**:
1. **Establish**: Client connects to `/sse`
2. **Register**: Server creates connection object
3. **Handshake**: Client sends `initialize` method
4. **Active**: Connection ready for tool calls
5. **Maintain**: Keep-alive pings every 30 seconds
6. **Cleanup**: Close on timeout (5 minutes idle) or client disconnect

**Connection Pooling**:
```python
class ConnectionPool:
    def __init__(self, max_connections: int = 100):
        self.connections: Dict[str, Connection] = {}
        self.max_connections = max_connections
    
    async def add_connection(self, conn: Connection) -> bool:
        if len(self.connections) >= self.max_connections:
            return False  # Reject new connection
        self.connections[conn.id] = conn
        return True
    
    async def remove_connection(self, conn_id: str):
        if conn_id in self.connections:
            del self.connections[conn_id]
    
    async def cleanup_stale_connections(self):
        # Remove connections idle > 5 minutes
        now = datetime.now()
        stale = [
            conn_id for conn_id, conn in self.connections.items()
            if (now - conn.last_activity).seconds > 300
        ]
        for conn_id in stale:
            await self.remove_connection(conn_id)
```

**Timeout Strategy**:
| Timeout Type | Duration | Action |
|--------------|----------|--------|
| Connection idle | 5 minutes | Close connection |
| Tool call (Layer 1 only) | 60 seconds | Return timeout error |
| Tool call (Layer 1 + Layer 3) | 300 seconds | Return timeout error |
| Keep-alive interval | 30 seconds | Send ping |

### 4.4 Concurrency Model

**Architecture**: Asynchronous (asyncio)

**Rationale**:
- Handle multiple concurrent clients efficiently
- Non-blocking I/O for network operations
- Single Python process can handle 10+ clients
- Better resource utilization than threading

**Concurrency Strategy**:
```python
# Async handlers for I/O-bound operations
async def handle_sse_connection(request):
    # Non-blocking SSE connection
    pass

async def send_response(connection, response):
    # Non-blocking response sending
    pass

# Thread pool for CPU-bound Roger operations
executor = ThreadPoolExecutor(max_workers=10)

async def invoke_roger(path, options):
    # Run Roger in thread pool (Roger is synchronous)
    loop = asyncio.get_event_loop()
    result = await loop.run_in_executor(
        executor,
        _run_roger_sync,  # Synchronous function
        path,
        options
    )
    return result
```

**Concurrency Limits**:
- Max concurrent connections: 100
- Max concurrent Roger executions: 10
- Thread pool size: 10 workers

---

## 5. MCP Protocol Integration

### 5.1 MCP Protocol Overview

**MCP (Model Context Protocol)**: Standard protocol for LLM tool integration

**Key Concepts**:
- **Server**: Exposes tools (Roger)
- **Client**: Invokes tools (Claude Code)
- **Transport**: HTTP/SSE
- **Message Format**: JSON-RPC 2.0
- **Tool**: Callable function with typed parameters

### 5.2 MCP Server Capabilities

Roger MCP Server declares the following capabilities:

```json
{
  "capabilities": {
    "tools": {
      "listChanged": false
    }
  },
  "serverInfo": {
    "name": "Roger CodeRabbit MCP Server",
    "version": "4.0.0"
  }
}
```

**Capabilities Explanation**:
- `tools.listChanged`: `false` - Tool list is static, won't change during session

### 5.3 Tool Definitions

Roger exposes one primary tool: `roger_review`

**Tool Definition**:
```json
{
  "name": "roger_review",
  "description": "Perform comprehensive code review using Layer 1 linters (bandit, pylint, mypy, radon, flake8, vulture) and optionally Layer 3 CodeRabbit analysis",
  "inputSchema": {
    "type": "object",
    "properties": {
      "path": {
        "type": "string",
        "description": "Path to file or directory to review"
      },
      "enable_layer3": {
        "type": "boolean",
        "description": "Enable Layer 3 CodeRabbit analysis",
        "default": true
      },
      "layer3_timeout": {
        "type": "integer",
        "description": "Timeout for Layer 3 operations (seconds)",
        "default": 120,
        "minimum": 30,
        "maximum": 600
      },
      "layer3_cache_enabled": {
        "type": "boolean",
        "description": "Enable Layer 3 Redis cache",
        "default": true
      }
    },
    "required": ["path"]
  }
}
```

### 5.4 MCP Method Handlers

#### Initialize Handler
**Method**: `initialize`  
**Purpose**: MCP protocol handshake  

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {
      "name": "claude-code",
      "version": "1.0.0"
    }
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "tools": {
        "listChanged": false
      }
    },
    "serverInfo": {
      "name": "Roger CodeRabbit MCP Server",
      "version": "4.0.0"
    }
  }
}
```

#### Tools List Handler
**Method**: `tools/list`  
**Purpose**: Return available tools  

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/list",
  "params": {}
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "tools": [
      {
        "name": "roger_review",
        "description": "Perform comprehensive code review...",
        "inputSchema": { /* see Tool Definition above */ }
      }
    ]
  }
}
```

#### Tool Call Handler
**Method**: `tools/call`  
**Purpose**: Execute Roger review  

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "roger_review",
    "arguments": {
      "path": "./src",
      "enable_layer3": true,
      "layer3_timeout": 120
    }
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "Code Review Results:\n\n**Layer 1 Analysis**\n- Security (bandit): 0 issues\n- Style (pylint): 3 issues\n- Types (mypy): 1 warning\n- Complexity (radon): Acceptable\n\n**Layer 3 Analysis (CodeRabbit)**\n- 2 suggestions for improvement\n\nDetails: [comprehensive findings]"
      }
    ],
    "isError": false
  }
}
```

### 5.5 Error Handling

**MCP Error Codes** (JSON-RPC 2.0 standard):
| Code | Meaning | Usage |
|------|---------|-------|
| -32700 | Parse error | Invalid JSON |
| -32600 | Invalid Request | Malformed request |
| -32601 | Method not found | Unknown MCP method |
| -32602 | Invalid params | Bad parameters |
| -32603 | Internal error | Server-side error |
| -32000 to -32099 | Server error | Roger-specific errors |

**Roger-Specific Error Codes**:
| Code | Error | Meaning |
|------|-------|---------|
| -32000 | Roger execution failed | General Roger error |
| -32001 | Roger timeout | Review took too long |
| -32002 | Invalid path | Path doesn't exist |
| -32003 | Permission denied | Cannot read path |
| -32004 | Layer 3 failure | CodeRabbit API error |

**Error Response Example**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "error": {
    "code": -32001,
    "message": "Roger timeout",
    "data": {
      "timeout": 300,
      "elapsed": 305,
      "details": "Layer 3 CodeRabbit analysis exceeded timeout"
    }
  }
}
```

---

## 6. Data Architecture

### 6.1 Data Flow Diagram

```
┌────────────────────────────────────────────────────────────────┐
│  End-to-End Data Flow                                          │
└────────────────────────────────────────────────────────────────┘

1. Client Request
   ┌──────────┐
   │ Claude   │
   │ Code     │
   └────┬─────┘
        │
        │ MCP Request (JSON-RPC 2.0)
        │ POST /sse
        │ {method: "tools/call", params: {...}}
        │
        ↓
   ┌────────────────────────────────────────┐
   │ Roger MCP Server                       │
   │                                        │
   │ 2. MCP Protocol Handler                │
   │    - Parse JSON-RPC                    │
   │    - Validate parameters               │
   │    - Route to handler                  │
   │                                        │
   │ 3. Roger Adapter                       │
   │    - Translate MCP → Roger params      │
   │    ┌──────────────────────────┐        │
   │    │ Parameters:              │        │
   │    │ - path: "./src"          │        │
   │    │ - enable_layer3: true    │        │
   │    │ - layer3_timeout: 120    │        │
   │    └──────────────────────────┘        │
   └────────────┬───────────────────────────┘
                │
                │ Roger Orchestrator Call
                │
                ↓
   ┌────────────────────────────────────────┐
   │ Roger Core (Phase 3)                   │
   │                                        │
   │ 4. Roger Orchestrator                  │
   │    ┌────────────────┐                  │
   │    │ Layer 1        │                  │
   │    │ - bandit       │ → Findings A     │
   │    │ - pylint       │ → Findings B     │
   │    │ - mypy         │ → Findings C     │
   │    │ - radon        │ → Findings D     │
   │    │ - flake8       │ → Findings E     │
   │    │ - vulture      │ → Findings F     │
   │    └────────────────┘                  │
   │           │                            │
   │           ↓                            │
   │    Aggregate Layer 1 Findings         │
   │           │                            │
   │           ↓                            │
   │    ┌────────────────┐                  │
   │    │ Layer 3        │                  │
   │    │ Check Cache    │──Yes─→ Use Cache│
   │    └────┬───────────┘                  │
   │         │ No                           │
   │         ↓                              │
   │    ┌────────────────┐                  │
   │    │ CodeRabbit CLI │                  │
   │    │ Invocation     │                  │
   │    └────┬───────────┘                  │
   │         │                              │
   │         ↓                              │
   │    ┌────────────────┐                  │
   │    │ Store in Cache │                  │
   │    └────┬───────────┘                  │
   │         │                              │
   │         ↓                              │
   │    Aggregate Layer 3 Findings         │
   │           │                            │
   │           ↓                            │
   │    Merge Layer 1 + Layer 3            │
   │           │                            │
   └───────────┼────────────────────────────┘
               │
               │ Roger Results
               │
               ↓
   ┌────────────────────────────────────────┐
   │ Roger MCP Server                       │
   │                                        │
   │ 5. Roger Adapter                       │
   │    - Format results as MCP response    │
   │    ┌──────────────────────────┐        │
   │    │ MCP Response:            │        │
   │    │ {                        │        │
   │    │   "result": {            │        │
   │    │     "content": [...]     │        │
   │    │   }                      │        │
   │    │ }                        │        │
   │    └──────────────────────────┘        │
   │                                        │
   │ 6. SSE Connection Manager              │
   │    - Send via SSE stream               │
   └────────────┬───────────────────────────┘
                │
                │ MCP Response (SSE)
                │ data: {jsonrpc: "2.0", result: {...}}
                │
                ↓
   ┌──────────┐
   │ Claude   │
   │ Code     │
   └──────────┘

External Data Dependencies:
   │
   ├─→ Redis Cache (127.0.0.1:6379)
   │   - Layer 3 CodeRabbit results
   │   - TTL: 1 hour
   │
   └─→ CodeRabbit CLI (external)
       - Invoked via subprocess
       - Network API calls
```

### 6.2 Data Models

#### Connection Model
```python
@dataclass
class Connection:
    """Represents an active SSE connection"""
    id: str                       # Unique connection ID
    client_ip: str               # Client IP address
    connected_at: datetime       # Connection start time
    last_activity: datetime      # Last message timestamp
    queue: asyncio.Queue         # Message queue for SSE
    protocol_version: str        # MCP protocol version
    client_info: Dict[str, Any]  # Client identification
```

#### MCP Request Model
```python
@dataclass
class MCPRequest:
    """MCP JSON-RPC request"""
    jsonrpc: str = "2.0"
    id: Union[str, int, None]
    method: str
    params: Optional[Dict[str, Any]] = None
```

#### MCP Response Model
```python
@dataclass
class MCPResponse:
    """MCP JSON-RPC response"""
    jsonrpc: str = "2.0"
    id: Union[str, int, None]
    result: Optional[Dict[str, Any]] = None
    error: Optional[MCPError] = None

@dataclass
class MCPError:
    """MCP error object"""
    code: int
    message: str
    data: Optional[Dict[str, Any]] = None
```

#### Roger Parameters Model
```python
@dataclass
class RogerParameters:
    """Parameters for Roger review"""
    path: str                              # Required: path to review
    enable_layer3: bool = True             # Enable CodeRabbit
    layer3_timeout: int = 120              # Layer 3 timeout (seconds)
    layer3_cache_enabled: bool = True      # Use Redis cache
    layer3_cache_ttl: int = 3600           # Cache TTL (seconds)
```

#### Roger Results Model
```python
@dataclass
class RogerResults:
    """Results from Roger review"""
    layer1_findings: List[Finding]         # Linter findings
    layer3_findings: List[Finding]         # CodeRabbit findings
    summary: Dict[str, Any]                # Summary statistics
    metadata: Dict[str, Any]               # Execution metadata
```

### 6.3 Configuration Data

**Configuration File**: `/opt/roger/config/server.yaml`

**Structure**:
```yaml
server:
  host: "0.0.0.0"
  port: 8005
  workers: 4
  timeout: 300

roger_core:
  layer1_enabled: true
  layer3_enabled: true
  layer3_timeout: 120
  layer3_cache_enabled: true
  layer3_cache_ttl: 3600

redis:
  host: "127.0.0.1"
  port: 6379
  db: 0

logging:
  file: "/opt/roger/logs/roger.log"
  level: "INFO"
  format: "json"

paths:
  cache_dir: "/opt/roger/cache"
  data_dir: "/opt/roger/data"
```

### 6.4 Logging Data

**Log Formats**:

**Structured JSON Logging**:
```json
{
  "timestamp": "2025-11-11T12:00:00Z",
  "level": "INFO",
  "component": "MCP_HANDLER",
  "event": "tool_call_received",
  "connection_id": "conn_123",
  "client_ip": "192.168.10.224",
  "method": "tools/call",
  "tool": "roger_review",
  "path": "./src"
}
```

**Log Levels**:
| Level | Usage |
|-------|-------|
| DEBUG | Development debugging |
| INFO | Normal operations |
| WARNING | Potential issues |
| ERROR | Errors requiring attention |
| CRITICAL | System failures |

---

## 7. Security Architecture

### 7.1 Phase 4.0 Security Model

**Current State** (Phase 4.0):
- **Network Isolation**: Internal network only (192.168.10.0/24)
- **No Authentication**: Trusted internal network
- **No Encryption**: HTTP (not HTTPS)
- **File System Isolation**: Roger runs as dedicated user (roger-service)

**Threat Model**:
| Threat | Likelihood | Impact | Mitigation (Phase 4.0) |
|--------|------------|--------|------------------------|
| Unauthorized external access | Very Low | High | Network perimeter (no external exposure) |
| Malicious internal user | Low | Medium | Network isolation, dedicated user |
| Path traversal attack | Low | Medium | Path validation in Roger adapter |
| Resource exhaustion (DoS) | Low | Medium | Connection limits, timeouts |
| Code injection | Very Low | High | No user code execution |
| Data exfiltration | Very Low | Low | No sensitive data processed |

### 7.2 Defense in Depth Layers

```
┌─────────────────────────────────────────────────────────────┐
│  Layer 1: Network Perimeter                                 │
│  - Internal network only (192.168.10.0/24)                  │
│  - No public internet exposure                              │
│  - Firewall rules (if enabled)                              │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│  Layer 2: Service Isolation                                 │
│  - Dedicated user (roger-service)                           │
│  - No login shell                                           │
│  - Restricted file permissions                              │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│  Layer 3: Resource Limits                                   │
│  - Connection limits (max 100)                              │
│  - Concurrent execution limits (max 10)                     │
│  - Request timeouts (300 seconds)                           │
│  - Memory limits (2GB via systemd)                          │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│  Layer 4: Input Validation                                  │
│  - Path existence validation                                │
│  - Parameter type validation                                │
│  - MCP protocol validation                                  │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│  Layer 5: Monitoring & Logging                              │
│  - All requests logged                                      │
│  - Error tracking                                           │
│  - Performance monitoring                                   │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 Input Validation

**Path Validation**:
```python
def validate_path(path: str) -> bool:
    """Validate path parameter"""
    # Must exist
    if not os.path.exists(path):
        raise ValueError(f"Path does not exist: {path}")
    
    # Must be readable
    if not os.access(path, os.R_OK):
        raise PermissionError(f"Path not readable: {path}")
    
    # Prevent path traversal (no escaping base directories)
    real_path = os.path.realpath(path)
    # Additional checks as needed
    
    return True
```

**Parameter Validation**:
```python
def validate_roger_params(params: Dict[str, Any]) -> RogerParameters:
    """Validate and parse Roger parameters"""
    # Required parameters
    if "path" not in params:
        raise ValueError("Missing required parameter: path")
    
    # Type validation
    path = str(params["path"])
    enable_layer3 = bool(params.get("enable_layer3", True))
    
    # Range validation
    timeout = int(params.get("layer3_timeout", 120))
    if not (30 <= timeout <= 600):
        raise ValueError("layer3_timeout must be between 30 and 600")
    
    return RogerParameters(
        path=path,
        enable_layer3=enable_layer3,
        layer3_timeout=timeout
    )
```

### 7.4 Phase 4.1 Security Enhancements (Future)

**Planned Security Improvements**:

#### Kerberos Authentication
```
Client                      Roger MCP Server              Samba DC
  │                              │                            │
  │ 1. Request KDC ticket        │                            │
  │─────────────────────────────────────────────────────────>│
  │                              │                            │
  │ 2. TGT issued                │                            │
  │<─────────────────────────────────────────────────────────│
  │                              │                            │
  │ 3. Request service ticket    │                            │
  │─────────────────────────────────────────────────────────>│
  │                              │                            │
  │ 4. Service ticket issued     │                            │
  │<─────────────────────────────────────────────────────────│
  │                              │                            │
  │ 5. MCP request + ticket      │                            │
  │─────────────────────────────>│                            │
  │                              │ 6. Validate ticket         │
  │                              │───────────────────────────>│
  │                              │                            │
  │                              │ 7. Ticket valid            │
  │                              │<───────────────────────────│
  │                              │                            │
  │ 8. Process request           │                            │
  │                              │                            │
```

#### TLS/HTTPS Encryption
- **Certificate**: From hx-ca-server (Frank Lucas)
- **Protocol**: TLS 1.3
- **URL**: `https://hx-coderabbit-server.hx.dev.local:8005/sse`
- **Certificate Renewal**: Automated via Frank Lucas

#### API Key Authentication (Backup)
- Per-client API keys
- Keys managed in configuration
- Rotation policy: 90 days

---

## 8. Deployment Architecture

### 8.1 Deployment Topology

```
┌───────────────────────────────────────────────────────────────┐
│  Hana-X Infrastructure (192.168.10.0/24)                      │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Layer 1: Identity & Trust (.200-.203)                  │ │
│  │                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ hx-dc-      │  │ hx-ca-      │  │ hx-ssl-     │    │ │
│  │  │ server      │  │ server      │  │ server      │    │ │
│  │  │ .200        │  │ .201        │  │ .202        │    │ │
│  │  │             │  │             │  │             │    │ │
│  │  │ DNS         │  │ CA          │  │ TLS Proxy   │    │ │
│  │  │ Kerberos    │  │ Certs       │  │ (Phase 4.1) │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Layer 4: Agentic & Toolchain (.213-.220, .228-.229)   │ │
│  │                                                         │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  hx-coderabbit-server (192.168.10.228)     ⭐   │  │ │
│  │  │                                                  │  │ │
│  │  │  ┌────────────────────────────────────────────┐ │  │ │
│  │  │  │  Roger MCP Server                          │ │  │ │
│  │  │  │  - Port: 8005                              │ │  │ │
│  │  │  │  - Protocol: HTTP/SSE (Phase 4.0)          │ │  │ │
│  │  │  │  - Protocol: HTTPS/SSE (Phase 4.1)         │ │  │ │
│  │  │  │  - User: roger-service                     │ │  │ │
│  │  │  │  - Python: 3.12.3                          │ │  │ │
│  │  │  └────────────────────────────────────────────┘ │  │ │
│  │  │                                                  │  │ │
│  │  │  ┌────────────────────────────────────────────┐ │  │ │
│  │  │  │  Redis Cache (Local)                       │ │  │ │
│  │  │  │  - Port: 6379 (127.0.0.1)                  │ │  │ │
│  │  │  │  - Purpose: Layer 3 cache                  │ │  │ │
│  │  │  └────────────────────────────────────────────┘ │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Layer 6: Integration & Governance (.224-.226)          │ │
│  │                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ hx-cc-      │  │ hx-metric-  │  │ hx-lang-    │    │ │
│  │  │ server      │  │ server      │  │ server      │    │ │
│  │  │ .224        │  │ .225        │  │ .226        │    │ │
│  │  │             │  │             │  │             │    │ │
│  │  │ Claude Code │  │ Monitoring  │  │ LangChain   │    │ │
│  │  │ (Client)    │  │ (Observes)  │  │             │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Layer 5: Application (.221-.223, .227)                 │ │
│  │                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ hx-dev-     │  │ hx-demo-    │  │ hx-webui-   │    │ │
│  │  │ server      │  │ server      │  │ server      │    │ │
│  │  │ .222        │  │ .223        │  │ .227        │    │ │
│  │  │             │  │             │  │             │    │ │
│  │  │ Claude Code │  │ Claude Code │  │ Web UI      │    │ │
│  │  │ (Client)    │  │ (Client)    │  │             │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
```

### 8.2 Server Specification

**hx-coderabbit-server.hx.dev.local**:
- **IP Address**: 192.168.10.228
- **OS**: Ubuntu 24.04 LTS (kernel 6.14.0-33-generic)
- **Python**: 3.12.3
- **CPU**: 2+ cores (4 recommended)
- **RAM**: 4GB minimum (8GB recommended)
- **Disk**: 20GB available
- **Network**: 192.168.10.0/24 (internal only)

**Service Configuration**:
- **User**: roger-service (system user, no login)
- **Directory**: /opt/roger
- **Port**: 8005 (TCP)
- **Service Manager**: systemd (roger-mcp.service)
- **Logs**: /opt/roger/logs, systemd journal

### 8.3 Dependency Map

```
Roger MCP Server Dependencies

┌────────────────────────────────────────────────────┐
│  Roger MCP Server                                  │
│  hx-coderabbit-server (192.168.10.228)            │
└──────────┬─────────────────────────────────────────┘
           │
           ├─→ Layer 1: Identity & Trust (REQUIRED)
           │   │
           │   ├─→ William Taylor (Ubuntu systems)
           │   │   • Server preparation
           │   │   • OS configuration
           │   │   • Service user creation
           │   │
           │   └─→ Frank Lucas (Samba DC)
           │       • Computer account
           │       • Service account
           │       • DNS A record
           │       • SSL certificate (Phase 4.1)
           │
           ├─→ Layer 3: Data Plane (REQUIRED)
           │   │
           │   └─→ Samuel Wilson (Redis)
           │       • Local Redis instance (127.0.0.1:6379)
           │       • Cache backend for Layer 3
           │       • Rate limiting storage
           │
           ├─→ External Services (REQUIRED)
           │   │
           │   └─→ CodeRabbit CLI
           │       • Installed at /usr/local/bin/coderabbit
           │       • External API access
           │
           └─→ Layer 6: Integration (OPTIONAL)
               │
               ├─→ Nathan Lewis (Monitoring)
               │   • Metrics collection
               │   • Health checks
               │   • Alerting
               │
               └─→ Amanda Chen (Automation)
                   • Ansible playbooks
                   • Automated deployments
```

### 8.4 Deployment Sequence

**Phase 1: Foundation Preparation**
1. William Taylor: Prepare hx-coderabbit-server infrastructure
2. Frank Lucas: Configure Samba DC accounts, DNS, SSL
3. Validation: Layer 1 complete

**Phase 2: Service Deployment**
1. Agent Zero: Deploy Roger MCP server
2. Samuel Wilson: Configure Redis cache
3. Validation: Service running

**Phase 3: Client Configuration**
1. Agent Zero: Configure Claude Code clients
2. Amanda Chen: Create Ansible automation
3. Validation: Clients connected

**Phase 4: Operations Handoff**
1. Nathan Lewis: Configure monitoring
2. Operations team training
3. Validation: Production ready

---

## 9. Performance Architecture

### 9.1 Performance Requirements

| Metric | Target | Measurement |
|--------|--------|-------------|
| Response Time (Layer 1 only) | < 60 seconds | 95th percentile |
| Response Time (Layer 1 + Layer 3) | < 300 seconds | 95th percentile |
| Concurrent Clients | 10+ | Simultaneous active connections |
| Connection Establishment | < 1 second | Time to first message |
| Memory Usage | < 2GB | Peak usage under load |
| CPU Usage | < 200% | Average across all cores |
| Uptime | 99.5% | Monthly SLA |

### 9.2 Performance Optimization Strategies

#### Caching Strategy (Layer 3)
**Cache Backend**: Redis  
**Cache Key**: `coderabbit:{repo_hash}:{file_hash}:{timestamp}`  
**TTL**: 3600 seconds (1 hour)  

**Cache Hit Scenarios**:
- Same file reviewed within TTL window
- No file modifications detected

**Cache Benefits**:
- Reduce CodeRabbit API calls (cost savings)
- Faster response times (no external API latency)
- Reduce load on CodeRabbit service

**Cache Metrics**:
- Target hit rate: > 70%
- Monitored by: Nathan Lewis

#### Connection Pooling
**Strategy**: Reuse connections where possible  
**Implementation**: asyncio-based connection management  
**Benefits**:
- Reduce connection overhead
- Better resource utilization
- Support more concurrent clients

#### Thread Pool Sizing
**Roger Execution Pool**: 10 workers  
**Rationale**:
- Roger is CPU-bound (linters)
- 10 concurrent reviews reasonable for 4-core server
- Prevents resource exhaustion

**Configuration**:
```python
executor = ThreadPoolExecutor(
    max_workers=10,
    thread_name_prefix="roger_worker"
)
```

### 9.3 Scalability Architecture

**Phase 4.0 - Single Server** (Current):
- Vertical scaling only
- Max 10 concurrent reviews
- CPU/memory constraints

**Phase 4.1 - Enhanced Single Server**:
- Optimized configuration
- Better caching
- Performance tuning

**Phase 4.2 - Horizontal Scaling** (Future):
```
┌─────────────────────────────────────────────────┐
│  Load Balancer                                  │
│  (nginx or haproxy)                             │
└──────────┬────────────┬────────────┬─────────────┘
           │            │            │
           ↓            ↓            ↓
      ┌────────┐   ┌────────┐   ┌────────┐
      │ Roger  │   │ Roger  │   │ Roger  │
      │ MCP 1  │   │ MCP 2  │   │ MCP 3  │
      └────────┘   └────────┘   └────────┘
           │            │            │
           └────────────┴────────────┘
                       │
                  ┌────▼────┐
                  │  Redis  │
                  │ Cluster │
                  └─────────┘
```

### 9.4 Performance Monitoring

**Key Metrics to Monitor**:

| Metric | Purpose | Alert Threshold |
|--------|---------|-----------------|
| Request rate | Load understanding | > 100 requests/hour |
| Response time (p95) | User experience | > 300 seconds |
| Error rate | Service health | > 5% |
| Connection count | Capacity planning | > 80 connections |
| CPU usage | Resource utilization | > 180% |
| Memory usage | Resource utilization | > 1.8GB |
| Cache hit rate | Performance optimization | < 50% |
| Roger execution time | Performance tuning | > 250 seconds |

**Monitoring Implementation**: Nathan Lewis (Layer 6)

---

## 10. Integration Architecture

### 10.1 Integration Points

```
Roger MCP Server Integration Map

┌─────────────────────────────────────────────────┐
│  Roger MCP Server                               │
└─────────────────────────────────────────────────┘
         │
         ├─→ Upstream Integrations (Clients)
         │   │
         │   ├─→ Claude Code (Multiple servers)
         │   │   • hx-cc-server (.224)
         │   │   • hx-dev-server (.222)
         │   │   • hx-demo-server (.223)
         │   │   • Protocol: MCP over HTTP/SSE
         │   │   • Port: 8005
         │   │
         │   ├─→ CI/CD Pipelines (Future)
         │   │   • GitHub Actions (Isaac Morgan)
         │   │   • Direct HTTP API calls
         │   │   • Automated code reviews
         │   │
         │   └─→ Custom Clients (Future)
         │       • Any MCP-compatible client
         │       • Internal tools integration
         │
         ├─→ Downstream Integrations (Dependencies)
         │   │
         │   ├─→ Redis Cache
         │   │   • Host: 127.0.0.1:6379
         │   │   • Purpose: Layer 3 cache
         │   │   • Owner: Samuel Wilson
         │   │
         │   ├─→ CodeRabbit CLI
         │   │   • Executable: /usr/local/bin/coderabbit
         │   │   • External API calls
         │   │   • Owner: Carlos Mendez
         │   │
         │   └─→ File System
         │       • Read access to code repositories
         │       • Permissions: roger-service user
         │
         └─→ Infrastructure Integrations
             │
             ├─→ Samba DC (Frank Lucas)
             │   • DNS resolution
             │   • Authentication (Phase 4.1)
             │   • Host: hx-dc-server (.200)
             │
             ├─→ Monitoring (Nathan Lewis)
             │   • Health checks
             │   • Metrics collection
             │   • Log aggregation
             │   • Host: hx-metric-server (.225)
             │
             └─→ Ansible (Amanda Chen)
                 • Automated deployment
                 • Configuration management
                 • Host: hx-control-node (.203)
```

### 10.2 Client Integration Pattern

**Standard Client Integration**:

1. **Configuration**: Add Roger to MCP servers config
```json
{
  "mcpServers": {
    "roger": {
      "transport": "sse",
      "url": "http://192.168.10.228:8005/sse",
      "timeout": 300000
    }
  }
}
```

2. **Connection**: Claude Code establishes SSE connection

3. **Tool Discovery**: Client requests available tools (`tools/list`)

4. **Tool Usage**: Client invokes `roger_review` tool

5. **Results**: Client receives formatted code review results

### 10.3 Redis Integration

**Purpose**: Layer 3 CodeRabbit cache backend  
**Owner**: Samuel Wilson  
**Integration Type**: Direct connection via redis-py  

**Connection Configuration**:
```python
import redis

redis_client = redis.Redis(
    host='127.0.0.1',
    port=6379,
    db=0,
    decode_responses=True
)
```

**Cache Operations**:
```python
# Store cache entry
redis_client.setex(
    f"coderabbit:{key}",
    3600,  # TTL: 1 hour
    json.dumps(result)
)

# Retrieve cache entry
cached = redis_client.get(f"coderabbit:{key}")
if cached:
    result = json.loads(cached)
```

### 10.4 Monitoring Integration

**Purpose**: Operational observability  
**Owner**: Nathan Lewis  
**Integration Type**: Push metrics, pull logs  

**Health Check Endpoint**:
```http
GET http://192.168.10.228:8005/health

Response:
{
  "status": "healthy",
  "version": "4.0.0",
  "uptime": 86400,
  "connections": {
    "active": 5,
    "total": 127
  },
  "roger": {
    "layer1_enabled": true,
    "layer3_enabled": true
  },
  "redis": {
    "connected": true
  }
}
```

**Metrics Endpoint (Future)**:
```http
GET http://192.168.10.228:8005/metrics

Response: Prometheus format
```

**Log Integration**:
- **Systemd Journal**: `journalctl -u roger-mcp.service`
- **File Logs**: `/opt/roger/logs/roger.log`
- **Format**: JSON structured logging

---

## 11. Operational Architecture

### 11.1 Operational Model

**Service Management**: systemd  
**Service Name**: `roger-mcp.service`  
**Owner**: Nathan Lewis (operations), Agent Zero (development)  

**Service States**:
```
┌──────────┐
│ Inactive │  systemctl start roger-mcp
└────┬─────┘
     │
     ↓
┌──────────┐
│ Starting │  Pre-start checks
└────┬─────┘
     │
     ↓
┌──────────┐
│  Active  │  ← Normal operation
│ (Running)│
└────┬─────┘
     │
     ├─→ systemctl reload roger-mcp  ← Configuration reload
     │   (stays active)
     │
     ├─→ systemctl restart roger-mcp ← Full restart
     │   (stop → start)
     │
     └─→ systemctl stop roger-mcp
         │
         ↓
    ┌──────────┐
    │ Inactive │
    └──────────┘
```

**Restart Policy**:
- **Automatic restart**: On failure
- **Restart delay**: 10 seconds
- **Max restarts**: 5 in 200 seconds
- **After limit**: Service stops, manual intervention required

### 11.2 Logging Architecture

**Log Destinations**:
1. **Systemd Journal** (primary)
2. **File logs** (secondary): `/opt/roger/logs/roger.log`
3. **Centralized logging** (future): Log aggregation service

**Log Levels**:
```
DEBUG → Development troubleshooting
  ↓
INFO → Normal operations (default)
  ↓
WARNING → Potential issues
  ↓
ERROR → Errors requiring attention
  ↓
CRITICAL → System failures
```

**Log Retention**:
- **File logs**: 7 days (logrotate)
- **Systemd journal**: 1 month (journald config)

**Log Access**:
```bash
# Real-time logs
journalctl -u roger-mcp.service -f

# Recent logs
journalctl -u roger-mcp.service -n 100

# Logs by time
journalctl -u roger-mcp.service --since "1 hour ago"

# File logs
tail -f /opt/roger/logs/roger.log
```

### 11.3 Backup & Recovery

**Backup Strategy**:

**Configuration Backup** (Daily):
- `/opt/roger/config/server.yaml`
- `/etc/systemd/system/roger-mcp.service`
- Retention: 30 days

**Code Backup**:
- Source code in Git repository
- No server-side backup needed (can redeploy)

**Redis Cache**:
- No backup required (cache data, can rebuild)
- Optional: Redis RDB snapshots for faster recovery

**Recovery Procedures**:

**Scenario 1: Service crash**
```bash
# Systemd auto-restarts
# If restart fails, check logs:
journalctl -u roger-mcp.service -n 100

# Manual restart:
sudo systemctl restart roger-mcp.service
```

**Scenario 2: Configuration corruption**
```bash
# Restore from backup
sudo cp /opt/roger/config/backups/server-YYYYMMDD.yaml \
        /opt/roger/config/server.yaml

# Restart service
sudo systemctl restart roger-mcp.service
```

**Scenario 3: Complete server failure**
```bash
# Redeploy from prerequisites
# 1. Follow PHASE4-PREREQUISITES-SETUP.md
# 2. Follow PHASE4-IMPLEMENTATION.md
# 3. Restore configuration
# 4. Start service
```

### 11.4 Maintenance Procedures

**Regular Maintenance**:

**Weekly** (Tuesdays 02:00-04:00 UTC):
- Apply security updates (William Taylor)
- Restart services if needed
- Verify health checks

**Monthly**:
- Review logs for patterns
- Analyze performance metrics
- Update dependencies
- Test disaster recovery

**Quarterly**:
- Security audit
- Performance review
- Capacity planning
- Documentation updates

**Maintenance Windows**:
- **Standard**: Tuesdays 02:00-04:00 UTC
- **Emergency**: As needed with 1-hour notice

---

## 12. Architecture Decision Records

### 12.1 ADR-001: HTTP/SSE Transport Selection

**Status**: Accepted  
**Date**: 2025-11-11  
**Author**: Alex Rivera  
**Reviewers**: Agent Zero  

**Context**:
Need to select network transport protocol for exposing Roger as MCP server.

**Decision**:
Use HTTP with Server-Sent Events (SSE) for MCP transport.

**Rationale**:
1. **MCP Standard**: SSE is specified transport in MCP protocol
2. **Simplicity**: Easier than WebSockets, standard HTTP
3. **Unidirectional**: Fits MCP server → client message pattern
4. **Firewall-Friendly**: Standard HTTP/HTTPS ports
5. **Tooling**: Good library support (Starlette, Uvicorn)

**Alternatives Considered**:
- **WebSockets**: More complex, bidirectional unnecessary
- **gRPC**: Non-standard for MCP, more complex setup
- **REST API**: Polling-based, inefficient for long-running operations

**Consequences**:
- ✅ Standards-compliant MCP server
- ✅ Simple implementation
- ✅ Good performance characteristics
- ⚠️ Requires keep-alive management
- ⚠️ Not optimal for bidirectional communication (not needed)

### 12.2 ADR-002: Layered Architecture with Zero Core Changes

**Status**: Accepted  
**Date**: 2025-11-11  
**Author**: Alex Rivera  
**Reviewers**: Agent Zero  

**Context**:
Roger Phase 3 is production-ready with 7,532 lines of code and 170 tests. Need to add network accessibility without regression risk.

**Decision**:
Implement strict layered architecture with new HTTP/SSE transport layer wrapping existing Roger core. Zero modifications to Phase 3 code.

**Rationale**:
1. **Risk Mitigation**: Don't touch working code (7,532 lines, 97% test pass)
2. **Separation of Concerns**: Transport logic separate from business logic
3. **Maintainability**: Clear boundaries, easier to understand
4. **Testability**: Can test transport layer independently
5. **Future-Proof**: Easy to add alternative transports

**Implementation**:
```
Layer 4: HTTP Server (NEW)
    ↓
Layer 3: MCP Protocol (NEW)
    ↓
Layer 2: Transport Adapter (NEW)
    ↓
Layer 1: Roger Core (UNCHANGED - Phase 3)
```

**Alternatives Considered**:
- **Modify Roger Core**: High risk, regression potential
- **Fork Roger Core**: Maintenance burden, divergence
- **Rewrite Roger**: Wasted effort, unnecessary risk

**Consequences**:
- ✅ Zero regression risk for Phase 3 functionality
- ✅ Clean architecture, maintainable
- ✅ Easy to test new code
- ⚠️ Additional abstraction layer (minimal overhead)
- ⚠️ Python import overhead (negligible)

### 12.3 ADR-003: Asyncio for Concurrency

**Status**: Accepted  
**Date**: 2025-11-11  
**Author**: Alex Rivera  
**Reviewers**: Agent Zero  

**Context**:
Need to handle multiple concurrent clients efficiently on single server.

**Decision**:
Use asyncio for HTTP/SSE transport layer, with thread pool for Roger execution.

**Rationale**:
1. **I/O Efficiency**: Asyncio excellent for network I/O
2. **Resource Efficiency**: Single process can handle many connections
3. **Python Standard**: Standard library, mature ecosystem
4. **Framework Support**: Uvicorn, Starlette are asyncio-based
5. **Hybrid Approach**: Async for I/O, threads for CPU-bound Roger

**Implementation**:
- Async HTTP handlers
- Async SSE connection management
- Thread pool executor for Roger invocation (synchronous)

**Alternatives Considered**:
- **Multi-threading**: Higher overhead, GIL limitations
- **Multi-processing**: Complex IPC, resource inefficient
- **Synchronous**: Poor concurrency, low scalability

**Consequences**:
- ✅ Efficient resource utilization
- ✅ Good concurrency (10+ clients)
- ✅ Standard Python patterns
- ⚠️ Async/sync bridging complexity (managed in adapter)
- ⚠️ Debugging can be more complex

### 12.4 ADR-004: No Authentication in Phase 4.0

**Status**: Accepted  
**Date**: 2025-11-11  
**Author**: Alex Rivera  
**Reviewers**: Agent Zero, Frank Lucas  

**Context**:
Need to decide authentication approach for initial Phase 4.0 deployment.

**Decision**:
Deploy Phase 4.0 with no authentication, relying on network isolation. Defer authentication to Phase 4.1.

**Rationale**:
1. **Internal Network**: 192.168.10.0/24 is trusted internal network
2. **Network Isolation**: No external exposure
3. **Faster Delivery**: Simplifies Phase 4.0 implementation
4. **Incremental Security**: Can add auth in Phase 4.1 without disrupting users
5. **Operational Simplicity**: Easier initial deployment

**Deferred to Phase 4.1**:
- Kerberos authentication via Samba DC
- TLS/HTTPS encryption
- API key authentication (backup)

**Alternatives Considered**:
- **Kerberos from Start**: More complex, longer timeline
- **API Keys from Start**: Credential management complexity
- **IP Whitelisting**: Limited value on internal network

**Consequences**:
- ✅ Faster Phase 4.0 delivery
- ✅ Simpler initial implementation
- ✅ Easier testing and validation
- ⚠️ Reliance on network security
- ⚠️ No client identification (Phase 4.0)
- ⚠️ No audit trail of access (Phase 4.0)
- ✅ Clear path to Phase 4.1 security enhancements

**Risk Mitigation**:
- Internal network only (no external exposure)
- Firewall rules (if enabled)
- Dedicated service user (roger-service)
- Plan for Phase 4.1 authentication ready

### 12.5 ADR-005: Single Server Deployment (Phase 4.0)

**Status**: Accepted  
**Date**: 2025-11-11  
**Author**: Alex Rivera  
**Reviewers**: Agent Zero  

**Context**:
Need to decide initial deployment topology for Roger MCP server.

**Decision**:
Deploy as single server (hx-coderabbit-server) for Phase 4.0. Defer high availability and load balancing to Phase 4.2.

**Rationale**:
1. **Sufficient Capacity**: Single server handles expected load (10 concurrent clients)
2. **Simplicity**: Easier deployment, operation, troubleshooting
3. **Cost-Effective**: Minimal resource usage
4. **Incremental Scaling**: Can add HA later if needed
5. **Fast Delivery**: Speeds up Phase 4.0 completion

**Expected Load**:
- Concurrent clients: 10-15 (peak)
- Daily reviews: 50-100
- Single server sufficient

**Deferred to Phase 4.2**:
- Load balancing
- Multiple server instances
- Redis cluster
- Geographic distribution

**Alternatives Considered**:
- **Multi-Server from Start**: Premature, unnecessary complexity
- **Container Orchestration**: Overkill for current scale

**Consequences**:
- ✅ Simple deployment and operations
- ✅ Faster time to production
- ✅ Lower resource costs
- ✅ Easier troubleshooting
- ⚠️ Single point of failure (acceptable for Phase 4.0)
- ⚠️ Limited horizontal scalability (sufficient for current needs)
- ✅ Clear upgrade path to HA in Phase 4.2

---

## Document Control

### Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-11-11 | Initial architecture document | Alex Rivera |

### Approval Signatures

**Document Approved By**:
- [ ] Alex Rivera (Platform Architect) - _________________
- [ ] Agent Zero (Universal PM Orchestrator) - _________________
- [ ] Steering Committee - _________________

**Document Status**: Draft (Pending Approval)  
**Next Review Date**: Upon Phase 4.0 completion or major changes

### Related Documents

**Prerequisites**: PHASE4-PREREQUISITES-SETUP.md  
**Client Configuration**: PHASE4-CLIENT-CONFIGURATION.md  
**Roles & Responsibilities**: PHASE4-ROLES-RESPONSIBILITIES.md  
**Implementation Guide**: PHASE4-IMPLEMENTATION.md (future)  
**Operations Manual**: PHASE4-OPERATIONS.md (future)  

---

**End of Architecture Document**

*This document defines the complete technical architecture for Roger MCP Server Phase 4.0. All implementation work must follow this architectural design. Any deviations require an ADR and approval from Alex Rivera (Platform Architect) and Agent Zero (PM).*
